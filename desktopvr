<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HAUS TAINACH – Desktop Viewer + VR</title>

  <script type="module" src="https://unpkg.com/@google/model-viewer@3.5.0/dist/model-viewer.min.js"></script>

  <style>
    :root{
      --bg:#06070a;
      --panel:rgba(18,18,22,.78);
      --stroke:rgba(255,255,255,.14);
      --txt:#fff;
      --muted:rgba(255,255,255,.70);
      --good:#47e37b;
      --warn:#f7c948;
      --bad:#ff5d5d;
      --r:16px;
    }
    html,body{margin:0;height:100%;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto;}
    model-viewer{
      width:100%;
      height:100vh;
      display:block;
      background:radial-gradient(1200px 700px at 50% 25%, rgba(255,255,255,.08), rgba(0,0,0,.92));
      --progress-bar-color: rgba(255,255,255,.0);
    }

    /* Topbar */
    .topbar{
      position:fixed; left:14px; right:14px; top:14px;
      z-index:30;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      pointer-events:none;
    }

    .pills{display:flex; gap:8px; flex-wrap:wrap; pointer-events:auto;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.10);
      color:var(--muted);
      font-size:12px;
      user-select:none;
      backdrop-filter: blur(10px);
    }
    .dot{width:9px;height:9px;border-radius:50%;background:var(--warn);}
    .dot.ok{background:var(--good);}
    .dot.bad{background:var(--bad);}

    /* Menu button (big red) */
    #togglePanel{
      pointer-events:auto;
      appearance:none;
      border:1px solid rgba(255,255,255,.28);
      background:#e53935;
      color:#fff;
      border-radius:16px;
      min-width:56px;
      min-height:56px;
      padding:14px 18px;
      font-size:22px;
      line-height:1;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 10px 28px rgba(229,57,53,.35);
      cursor:pointer;
    }
    #togglePanel:hover{background:#ff3b30;}
    #togglePanel:active{transform:scale(.98);}

    /* Panel */
    .panel{
      position:fixed;
      left:14px;
      top:84px;
      width:440px;
      max-width:calc(100vw - 28px);
      z-index:25;
      pointer-events:auto;
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--r);
      backdrop-filter: blur(14px);
      padding:14px;
      color:var(--txt);
    }
    .panel.collapsed .content{display:none;}
    .panel .head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .title{
      margin:0;
      font-size:16px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .sub{
      margin:6px 0 0 0;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    .row{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px;}
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      color:#fff;
      border-radius:14px;
      padding:10px 12px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{transform:scale(.98)}
    .btn.primary{
      background:#e53935;
      border:1px solid rgba(255,255,255,.28);
      box-shadow: 0 10px 28px rgba(229,57,53,.22);
      font-weight:800;
    }
    .btn.ghost{background:rgba(255,255,255,.07);}

    .sliderRow{
      display:flex; align-items:center; gap:10px;
      margin-top:10px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      background:rgba(255,255,255,.06);
    }
    .sliderRow label{
      width:76px;
      font-size:12px;
      color:var(--muted);
    }
    .sliderRow input[type="range"]{flex:1;}
    .val{
      width:78px;
      text-align:right;
      font-size:12px;
      color:var(--muted);
    }

    .small{
      margin-top:10px;
      font-size:11px;
      color:rgba(255,255,255,.55);
      line-height:1.35;
    }

    /* Progress overlay inside model-viewer */
    .progressWrap{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      width:min(520px, calc(100vw - 40px));
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.45);
      border-radius:18px;
      padding:14px 14px 12px 14px;
      color:#fff;
      backdrop-filter: blur(10px);
    }
    .progressTitle{font-weight:900;letter-spacing:.2px;}
    .progressBar{
      margin-top:10px;
      height:10px;
      border-radius:999px;
      overflow:hidden;
      background:rgba(255,255,255,.14);
    }
    .progressBar > div{
      height:100%;
      width:0%;
      background:rgba(255,255,255,.85);
    }
    .progressMeta{
      margin-top:8px;
      display:flex;justify-content:space-between;
      font-size:12px;color:rgba(255,255,255,.75);
    }

    @media (max-width: 900px){
      .panel{width:calc(100vw - 28px);}
    }
  </style>
</head>

<body>

  <!-- Topbar -->
  <div class="topbar">
    <div class="pills">
      <span class="pill"><span id="mDot" class="dot"></span><span id="mTxt">Modell: lädt…</span></span>
      <span class="pill"><span id="pDot" class="dot"></span><span id="pTxt">Panorama: prüfen…</span></span>
      <span class="pill"><span id="vDot" class="dot"></span><span id="vTxt">VR: prüfen…</span></span>
    </div>

    <button id="togglePanel" type="button" aria-label="Menü">☰</button>
  </div>

  <!-- Panel -->
  <div id="panel" class="panel">
    <div class="head">
      <div>
        <h1 class="title">HAUS TAINACH · Desktop</h1>
        <p class="sub">
          Viewer + Panorama (Skybox) + VR-Link (Quest).<br>
          Dateien im Repo-Root: <b>HAUS_TAINACH.glb</b> · <b>TAINACH_PANO.jpg</b> · <b>vr.html</b>
        </p>
      </div>
    </div>

    <div class="content">
      <div class="row">
        <button id="panoToggle" class="btn ghost" type="button">Panorama: AN</button>
        <button id="reset" class="btn" type="button">Kamera Reset</button>
        <button id="rot" class="btn" type="button">Auto-Rotate: AN</button>
        <button id="fs" class="btn" type="button">Fullscreen</button>
        <button id="openVR" class="btn primary" type="button">VR öffnen</button>
        <a class="btn" href="index.html" style="text-decoration:none;">Hub</a>
      </div>

      <div class="sliderRow">
        <label>Scale</label>
        <input id="scale" type="range" min="1" max="20" step="1" value="12" />
        <div class="val" id="scaleVal">12×</div>
      </div>

      <div class="sliderRow">
        <label>Yaw</label>
        <input id="yaw" type="range" min="-180" max="180" step="1" value="-90" />
        <div class="val" id="yawVal">-90°</div>
      </div>

      <div class="sliderRow">
        <label>Zoom</label>
        <input id="dist" type="range" min="40" max="2000" step="10" value="320" />
        <div class="val" id="distVal">320m</div>
      </div>

      <div class="sliderRow">
        <label>FOV</label>
        <input id="fov" type="range" min="25" max="70" step="1" value="50" />
        <div class="val" id="fovVal">50°</div>
      </div>

      <div class="sliderRow">
        <label>Exposure</label>
        <input id="exp" type="range" min="0.60" max="1.60" step="0.01" value="1.10" />
        <div class="val" id="expVal">1.10</div>
      </div>

      <div class="sliderRow">
        <label>Shadow</label>
        <input id="sh" type="range" min="0" max="1" step="0.01" value="0.85" />
        <div class="val" id="shVal">0.85</div>
      </div>

      <div class="small">
        Hinweis: Skybox-Panorama = Foto auf Kugel (keine echte Bodenparallaxe).
      </div>
    </div>
  </div>

  <!-- Viewer -->
  <model-viewer
    id="mv"
    src="HAUS_TAINACH.glb"
    camera-controls
    auto-rotate
    rotation-per-second="10deg"
    interaction-prompt="none"
    loading="eager"
    reveal="auto"
    tone-mapping="aces"
    exposure="1.10"
    shadow-intensity="0.85"
    shadow-softness="0.65"
    environment-image="neutral"
    orientation="90deg -90deg 0deg"
    scale="12 12 12"
    camera-orbit="45deg 65deg 320m"
    min-camera-orbit="auto auto 0.2m"
    max-camera-orbit="auto auto 8000m"
    field-of-view="50deg"
  >
    <div slot="progress-bar" class="progressWrap" id="prog">
      <div class="progressTitle">HAUS TAINACH lädt…</div>
      <div class="progressBar"><div id="progBar"></div></div>
      <div class="progressMeta">
        <span id="progLeft">GLB</span>
        <span id="progRight">0%</span>
      </div>
    </div>
  </model-viewer>

  <script>
    const mv = document.getElementById('mv');

    const panel = document.getElementById('panel');
    document.getElementById('togglePanel').onclick = () => panel.classList.toggle('collapsed');

    const mDot = document.getElementById('mDot');
    const mTxt = document.getElementById('mTxt');
    const pDot = document.getElementById('pDot');
    const pTxt = document.getElementById('pTxt');
    const vDot = document.getElementById('vDot');
    const vTxt = document.getElementById('vTxt');

    const prog = document.getElementById('prog');
    const progBar = document.getElementById('progBar');
    const progRight = document.getElementById('progRight');

    const scale = document.getElementById('scale');
    const yaw   = document.getElementById('yaw');
    const dist  = document.getElementById('dist');
    const fov   = document.getElementById('fov');
    const exp   = document.getElementById('exp');
    const sh    = document.getElementById('sh');

    const scaleVal = document.getElementById('scaleVal');
    const yawVal   = document.getElementById('yawVal');
    const distVal  = document.getElementById('distVal');
    const fovVal   = document.getElementById('fovVal');
    const expVal   = document.getElementById('expVal');
    const shVal    = document.getElementById('shVal');

    const panoBtn = document.getElementById('panoToggle');
    const resetBtn = document.getElementById('reset');
    const rotBtn = document.getElementById('rot');
    const fsBtn = document.getElementById('fs');
    const openVRBtn = document.getElementById('openVR');

    const PANO_FILE  = "TAINACH_PANO.jpg";
    const VR_PAGE    = "vr.html";

    let panoOn = true;

    async function headOk(rel){
      try{
        const url = new URL(rel, location.href).toString();
        const r = await fetch(url, { method:"HEAD", cache:"no-store" });
        return r.ok;
      }catch{ return false; }
    }

    function setCameraDistance(meters){
      const o = mv.getCameraOrbit();
      mv.cameraOrbit = `${o.theta}rad ${o.phi}rad ${meters}m`;
    }

    function applyAll(){
      const s = Number(scale.value);
      const y = Number(yaw.value);
      const d = Number(dist.value);
      const f = Number(fov.value);
      const e = Number(exp.value);
      const si = Number(sh.value);

      mv.setAttribute('scale', `${s} ${s} ${s}`);
      mv.setAttribute('orientation', `90deg ${y}deg 0deg`);
      setCameraDistance(d);
      mv.fieldOfView = `${f}deg`;
      mv.exposure = e;
      mv.shadowIntensity = si;

      scaleVal.textContent = `${s}×`;
      yawVal.textContent   = `${y}°`;
      distVal.textContent  = `${d}m`;
      fovVal.textContent   = `${f}°`;
      expVal.textContent   = e.toFixed(2);
      shVal.textContent    = si.toFixed(2);
    }

    async function setPanorama(enabled){
      panoOn = enabled;

      if (!enabled){
        mv.setAttribute("environment-image","neutral");
        mv.removeAttribute("skybox-image");
        pDot.className = "dot ok";
        pTxt.textContent = "Panorama: AUS";
        panoBtn.textContent = "Panorama: AUS";
        return;
      }

      const ok = await headOk(PANO_FILE);
      if (!ok){
        pDot.className = "dot bad";
        pTxt.textContent = "Panorama: fehlt";
        panoBtn.textContent = "Panorama: fehlt";
        mv.setAttribute("environment-image","neutral");
        mv.removeAttribute("skybox-image");
        return;
      }

      mv.setAttribute("environment-image", PANO_FILE);
      mv.setAttribute("skybox-image", PANO_FILE);

      pDot.className = "dot ok";
      pTxt.textContent = "Panorama: AN";
      panoBtn.textContent = "Panorama: AN";
    }

    panoBtn.onclick = async () => setPanorama(!panoOn);

    resetBtn.onclick = () => {
      mv.cameraOrbit = "45deg 65deg 320m";
      mv.fieldOfView = "50deg";
      scale.value = "12";
      yaw.value = "-90";
      dist.value = "320";
      fov.value = "50";
      exp.value = "1.10";
      sh.value = "0.85";
      applyAll();
    };

    rotBtn.onclick = () => {
      if (mv.hasAttribute("auto-rotate")) {
        mv.removeAttribute("auto-rotate");
        rotBtn.textContent = "Auto-Rotate: AUS";
      } else {
        mv.setAttribute("auto-rotate","");
        rotBtn.textContent = "Auto-Rotate: AN";
      }
    };

    fsBtn.onclick = async () => {
      try{
        if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
        else await document.exitFullscreen();
      }catch{}
    };

    openVRBtn.onclick = () => window.location.href = VR_PAGE;

    (async () => {
      try{
        if (navigator.xr?.isSessionSupported) {
          const ok = await navigator.xr.isSessionSupported("immersive-vr");
          vDot.className = ok ? "dot ok" : "dot";
          vTxt.textContent = ok ? "VR: verfügbar" : "VR: nur Headset/Quest";
        } else {
          vDot.className = "dot";
          vTxt.textContent = "VR: nicht erkannt";
        }
      } catch {
        vDot.className = "dot";
        vTxt.textContent = "VR: prüfen fehlgeschlagen";
      }
    })();

    mv.addEventListener("progress", (ev) => {
      const p = Math.max(0, Math.min(1, ev.detail.totalProgress || 0));
      progBar.style.width = `${Math.round(p * 100)}%`;
      progRight.textContent = `${Math.round(p * 100)}%`;
    });

    mv.addEventListener("load", async () => {
      mDot.className = "dot ok";
      mTxt.textContent = "Modell: bereit";
      prog.style.display = "none";
      applyAll();
      await setPanorama(true);
    });

    mv.addEventListener("error", (e) => {
      mDot.className = "dot bad";
      mTxt.textContent = "Modell: Fehler";
      console.error(e);
    });

    [scale,yaw,dist,fov,exp,sh].forEach(el => el.addEventListener("input", applyAll));
  </script>

</body>
</html>
