<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>HAUS TAINACH</title>

<script type="module" src="https://unpkg.com/@google/model-viewer@3.5.0/dist/model-viewer.min.js"></script>

<style>
:root{
  --bg:#07080a;
  --panel:rgba(20,20,22,.78);
  --stroke:rgba(255,255,255,.12);
  --txt:#fff;
  --muted:rgba(255,255,255,.68);
  --good:#4be37a;
  --warn:#f7c948;
  --bad:#ff5d5d;
  --r:14px;
}
html,body{margin:0;height:100%;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto;}
model-viewer{width:100%;height:100vh;display:block;background:radial-gradient(1200px 700px at 50% 25%, rgba(255,255,255,.07), rgba(0,0,0,.92));}

.ui{position:fixed;left:8px;right:8px;top:8px;z-index:20;pointer-events:none;}
.panel{
  pointer-events:auto;
  background:var(--panel);
  border:1px solid var(--stroke);
  border-radius:var(--r);
  backdrop-filter:blur(12px);
  padding:10px;
  color:var(--txt);
  max-width:560px;
}
.title{font-size:14px;font-weight:800;margin:0 0 6px 0;}

.row{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-bottom:6px;}
.pill{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 10px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.08);
  color:var(--muted);font-size:11px;user-select:none;
}
.dot{width:8px;height:8px;border-radius:50%;background:var(--warn);}
.dot.ok{background:var(--good);}
.dot.bad{background:var(--bad);}

button{
  appearance:none;border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.08);
  color:#fff;border-radius:10px;
  padding:6px 10px;font-size:11px;cursor:pointer;
}
button:active{transform:scale(.97)}

.sliderRow{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.sliderRow label{font-size:11px;color:var(--muted);width:52px;}
input[type="range"]{flex:1;height:22px;}
.value{font-size:11px;width:64px;text-align:right;color:var(--muted);}

@media(min-width:700px){.panel{max-width:560px}}
</style>
</head>

<body>
<div class="ui">
  <div class="panel">
    <div class="title">HAUS TAINACH · 360°</div>

    <div class="row">
      <span class="pill"><span id="mDot" class="dot"></span><span id="mTxt">Lädt…</span></span>
      <span class="pill"><span id="pDot" class="dot"></span><span id="pTxt">Panorama…</span></span>
      <span class="pill"><span id="gDot" class="dot"></span><span id="gTxt">Boden…</span></span>
    </div>

    <div class="row">
      <button id="reset">Reset</button>
      <button id="rotateBtn">Rotate</button>
      <button id="groundBtn">Boden</button>
      <button id="fs">Full</button>
    </div>

    <!-- STARTWERTE: Scale höher, Yaw -90 -->
    <div class="sliderRow">
      <label>Scale</label>
      <input id="scale" type="range" min="6" max="20" step="1" value="12"/>
      <div class="value" id="scaleVal">12x</div>
    </div>

    <div class="sliderRow">
      <label>Yaw</label>
      <input id="yaw" type="range" min="-180" max="180" step="1" value="-90"/>
      <div class="value" id="yawVal">-90°</div>
    </div>

    <!-- Position (wirkt jetzt, weil camera-target folgt) -->
    <div class="sliderRow">
      <label>X</label>
      <input id="tx" type="range" min="-60" max="60" step="0.5" value="0"/>
      <div class="value" id="txVal">0.0m</div>
    </div>

    <div class="sliderRow">
      <label>Z</label>
      <input id="tz" type="range" min="-80" max="80" step="0.5" value="-16"/>
      <div class="value" id="tzVal">-16.0m</div>
    </div>

    <!-- Weitblick -->
    <div class="sliderRow">
      <label>Zoom</label>
      <input id="dist" type="range" min="30" max="800" step="5" value="220"/>
      <div class="value" id="distVal">220m</div>
    </div>

    <div class="sliderRow">
      <label>FOV</label>
      <input id="fov" type="range" min="20" max="70" step="1" value="45"/>
      <div class="value" id="fovVal">45°</div>
    </div>

  </div>
</div>

<model-viewer
  id="mv"
  src="HAUS_TAINACH.glb"
  camera-controls
  auto-rotate
  rotation-per-second="10deg"
  interaction-prompt="none"
  loading="eager"
  reveal="auto"

  tone-mapping="aces"
  exposure="1.10"
  shadow-intensity="0.90"
  shadow-softness="0.65"

  environment-image="TAINACH_PANO.jpg"
  skybox-image="TAINACH_PANO.jpg"

  orientation="90deg -90deg 0deg"
  scale="12 12 12"
  translation="0m 0m -16m"

  camera-target="0m 0m -16m"
  camera-orbit="45deg 65deg 220m"
  min-camera-orbit="auto auto 0.2m"
  max-camera-orbit="auto auto 5000m"
  field-of-view="45deg"
></model-viewer>

<script>
const mv = document.getElementById("mv");

// Status UI
const mDot = document.getElementById("mDot");
const mTxt = document.getElementById("mTxt");
const pDot = document.getElementById("pDot");
const pTxt = document.getElementById("pTxt");
const gDot = document.getElementById("gDot");
const gTxt = document.getElementById("gTxt");

// Inputs
const scale = document.getElementById("scale");
const yaw = document.getElementById("yaw");
const tx = document.getElementById("tx");
const tz = document.getElementById("tz");
const dist = document.getElementById("dist");
const fov = document.getElementById("fov");

// Labels
const scaleVal = document.getElementById("scaleVal");
const yawVal = document.getElementById("yawVal");
const txVal = document.getElementById("txVal");
const tzVal = document.getElementById("tzVal");
const distVal = document.getElementById("distVal");
const fovVal = document.getElementById("fovVal");

function parseTranslation(str){
  const parts = String(str || "0m 0m 0m").trim().split(/\s+/);
  const n = parts.map(p => parseFloat(p));
  return { x: n[0] || 0, y: n[1] || 0, z: n[2] || 0 };
}
function setTranslation(x,y,z){
  mv.setAttribute("translation", `${x}m ${y}m ${z}m`);
  // EXTREM WICHTIG: Kamera-Ziel folgt -> X/Z wirkt sofort sichtbar
  mv.setAttribute("camera-target", `${x}m 0m ${z}m`);
  mv.requestRender();
}

async function headOk(rel){
  try{
    const url = new URL(rel, location.href).toString();
    const r = await fetch(url, { method:"HEAD", cache:"no-store" });
    return r.ok;
  }catch(e){ return false; }
}

// Boden setzen: minY -> 0
function setGround(){
  const bbox = (typeof mv.getBoundingBox === "function") ? mv.getBoundingBox() : null;
  if (!bbox || !bbox.min || typeof bbox.min.y !== "number"){
    gDot.className = "dot bad";
    gTxt.textContent = "Boden: n/a";
    return;
  }
  const minY = bbox.min.y;
  const t = parseTranslation(mv.getAttribute("translation"));
  const newY = t.y - minY;
  mv.setAttribute("translation", `${t.x}m ${newY}m ${t.z}m`);
  // camera-target bleibt auf X/Z (Y=0 für intuitive Navigation)
  mv.setAttribute("camera-target", `${t.x}m 0m ${t.z}m`);
  gDot.className = "dot ok";
  gTxt.textContent = "Boden: ok";
}

function setCameraDistance(meters){
  // Wir behalten Winkel, ändern nur Radius (dist)
  const orbit = mv.getCameraOrbit();
  mv.cameraOrbit = `${orbit.theta}rad ${orbit.phi}rad ${meters}m`;
}

function updateAll(){
  const s = Number(scale.value);
  const y = Number(yaw.value);
  const x = Number(tx.value);
  const z = Number(tz.value);
  const d = Number(dist.value);
  const f = Number(fov.value);

  mv.setAttribute("scale", `${s} ${s} ${s}`);
  mv.setAttribute("orientation", `90deg ${y}deg 0deg`);

  const t = parseTranslation(mv.getAttribute("translation"));
  setTranslation(x, t.y, z);

  setCameraDistance(d);
  mv.fieldOfView = `${f}deg`;

  scaleVal.textContent = `${s}x`;
  yawVal.textContent = `${y}°`;
  txVal.textContent = `${x.toFixed(1)}m`;
  tzVal.textContent = `${z.toFixed(1)}m`;
  distVal.textContent = `${d}m`;
  fovVal.textContent = `${f}°`;

  // nach Änderungen Boden nachziehen (nach einem Frame)
  requestAnimationFrame(() => setGround());
}

// Events
mv.addEventListener("load", async () => {
  mDot.className = "dot ok";
  mTxt.textContent = "Modell bereit";

  const panoOk = await headOk("TAINACH_PANO.jpg");
  pDot.className = panoOk ? "dot ok" : "dot bad";
  pTxt.textContent = panoOk ? "Panorama aktiv" : "Panorama fehlt";

  updateAll();
});

mv.addEventListener("error", (e) => {
  mDot.className = "dot bad";
  mTxt.textContent = "Fehler";
  console.error(e);
});

// UI handlers
scale.oninput = updateAll;
yaw.oninput   = updateAll;
tx.oninput    = updateAll;
tz.oninput    = updateAll;
dist.oninput  = updateAll;
fov.oninput   = updateAll;

document.getElementById("reset").onclick = () => {
  // sinnvolle Default-Ansicht für "Weitblick"
  mv.cameraOrbit = "45deg 65deg 220m";
  mv.fieldOfView = "45deg";
};

document.getElementById("rotateBtn").onclick = () => {
  if (mv.hasAttribute("auto-rotate")) mv.removeAttribute("auto-rotate");
  else mv.setAttribute("auto-rotate","");
};

document.getElementById("groundBtn").onclick = () => setGround();

document.getElementById("fs").onclick = () => {
  if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
  else document.exitFullscreen().catch(()=>{});
};

// Sicherstellen: Yaw wirklich -90 beim Start
yaw.value = "-90";
yawVal.textContent = "-90°";
</script>
</body>
</html>
