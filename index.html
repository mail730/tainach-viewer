<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HAUS TAINACH – 3D/AR</title>

  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    :root{
      --bg:#0b0b0b;
      --panel: rgba(20,20,20,.78);
      --panel2: rgba(255,255,255,.08);
      --txt:#fff;
      --muted: rgba(255,255,255,.72);
      --accent: rgba(255,255,255,.18);
      --radius: 14px;
      --gap: 10px;
    }
    html,body{margin:0;height:100%;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    model-viewer{width:100%;height:100vh;background:var(--bg);}

    /* UI */
    .ui{
      position:fixed; left:12px; right:12px; top:12px;
      display:flex; gap:var(--gap); align-items:flex-start; justify-content:space-between;
      pointer-events:none;
      z-index:10;
    }
    .panel{
      pointer-events:auto;
      background:var(--panel);
      backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding: 10px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      max-width:min(520px, 100%);
    }
    .title{
      display:flex; align-items:center; gap:10px;
      color:var(--txt);
      font-weight:700;
      letter-spacing:.2px;
      font-size:14px;
      margin:0 0 8px 0;
    }
    .sub{
      margin: -6px 0 10px 0;
      color:var(--muted);
      font-size:12px;
      line-height:1.25;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 10px;
    }
    .row{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      background: var(--panel2);
      border: 1px solid rgba(255,255,255,.08);
      color: var(--txt);
      font-size: 13px;
      user-select:none;
    }
    .row small{color:var(--muted); font-size:11px;}
    .row label{display:flex; align-items:center; gap:8px; cursor:pointer; width:100%;}
    .row input{transform:scale(1.1);}
    .actions{
      display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;
    }
    button{
      appearance:none; border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
      color: var(--txt);
      border-radius: 12px;
      padding: 9px 10px;
      font-size: 13px;
      cursor:pointer;
    }
    button:hover{background: rgba(255,255,255,.14);}
    button:active{transform: translateY(1px);}

    .right{
      pointer-events:auto;
      display:flex; gap:8px; align-items:flex-start;
    }
    .pill{
      pointer-events:auto;
      background:var(--panel);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      padding: 8px 10px;
      color: var(--txt);
      font-size: 12px;
      display:flex; align-items:center; gap:8px;
      backdrop-filter: blur(10px);
    }
    .dot{width:8px; height:8px; border-radius:50%; background:#bbb; box-shadow:0 0 0 3px rgba(255,255,255,.08) inset;}
    .dot.ok{background:#47d16b;}
    .dot.bad{background:#ff5d5d;}
    .dot.wait{background:#f7c948;}

    /* Loader overlay */
    .loader{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1200px 700px at 50% 30%, rgba(255,255,255,.06), rgba(0,0,0,.92));
      z-index:20;
    }
    .loaderCard{
      width:min(420px, calc(100% - 24px));
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(15,15,15,.72);
      backdrop-filter: blur(10px);
      padding: 16px;
      color: var(--txt);
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
    }
    .loaderCard h1{
      margin:0 0 6px 0; font-size:15px; letter-spacing:.2px;
    }
    .loaderCard p{
      margin:0 0 12px 0; color:var(--muted); font-size:12px; line-height:1.35;
    }
    .bar{
      height:10px; border-radius: 999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: rgba(255,255,255,.45);
      transition: width .2s ease;
    }
    .meta{
      margin-top:10px;
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:12px;
    }
    .hidden{display:none!important;}

    /* Mobile: Panel breiter & 1 Spalte */
    @media (max-width: 520px){
      .grid{grid-template-columns:1fr;}
      .ui{left:10px; right:10px; top:10px;}
    }
  </style>
</head>

<body>
  <!-- Loader -->
  <div id="loader" class="loader">
    <div class="loaderCard">
      <h1>HAUS TAINACH</h1>
      <p>3D-Viewer lädt… (Mobile optimiert, AR verfügbar)</p>
      <div class="bar"><div id="barFill"></div></div>
      <div class="meta">
        <span id="pct">0%</span>
        <span id="hint">Tip: Zwei Finger = Zoomen</span>
      </div>
    </div>
  </div>

  <!-- UI -->
  <div class="ui">
    <div class="panel">
      <div class="title">Bauteile</div>
      <div class="sub">Schalte Bauteile ein/aus. (Objektnamen im GLB müssen passen.)</div>

      <div class="grid" id="toggles">
        <!-- wird per JS gefüllt -->
      </div>

      <div class="actions">
        <button id="allOn" type="button">Alle an</button>
        <button id="allOff" type="button">Alle aus</button>
        <button id="reset" type="button">Kamera Reset</button>
      </div>
    </div>

    <div class="right">
      <div class="pill" title="AR Status">
        <span id="arDot" class="dot wait"></span>
        <span id="arTxt">AR prüfen…</span>
      </div>
    </div>
  </div>

  <model-viewer
    id="mv"
    src="HAUSTAINACH.glb"
    camera-controls
    auto-rotate
    rotation-per-second="12deg"
    exposure="1"
    shadow-intensity="0"
    ar
    ar-modes="webxr scene-viewer quick-look"
    loading="eager"
    reveal="auto"
    camera-orbit="45deg 65deg 12m"
    min-camera-orbit="auto auto 4m"
    max-camera-orbit="auto auto 60m"
    interaction-prompt="none"
  >
  </model-viewer>

  <script type="module">
    const mv = document.getElementById('mv');

    // === Konfiguration: Diese Namen müssen im GLB exakt so existieren ===
    // (Du hast sie in Blender schon so benannt – perfekt.)
    const PARTS = [
      { id: 'DACH',       label: 'Dach' },
      { id: 'AUSSENWAND', label: 'Außenwand' },
      { id: 'FENSTER',    label: 'Fenster' },
      { id: 'GLAS',       label: 'Glas' },
      { id: 'DECKE_EG',   label: 'Decke EG' },
      { id: 'DECKE_OG',   label: 'Decke OG' },
    ];

    // === UI bauen ===
    const togglesEl = document.getElementById('toggles');
    function makeToggle(part){
      const div = document.createElement('div');
      div.className = 'row';
      div.innerHTML = `
        <label>
          <input type="checkbox" checked data-part="${part.id}">
          <span>${part.label}<br><small>${part.id}</small></span>
        </label>
      `;
      return div;
    }
    PARTS.forEach(p => togglesEl.appendChild(makeToggle(p)));

    // === Loader Progress ===
    const loader = document.getElementById('loader');
    const barFill = document.getElementById('barFill');
    const pct = document.getElementById('pct');

    mv.addEventListener('progress', (e) => {
      const v = Math.round((e.detail.totalProgress || 0) * 100);
      barFill.style.width = v + '%';
      pct.textContent = v + '%';
      if (v >= 100) {
        // Noch nicht sofort ausblenden — erst wenn gerendert
        pct.textContent = '100%';
      }
    });
    mv.addEventListener('load', () => {
      loader.classList.add('hidden');
      initScene();
      updateArStatus();
    });

    // === Scene: Nodes finden & Toggle anwenden ===
    let nodeMap = new Map();

    function findNodesByName(root, targetName){
      const out = [];
      if (!root) return out;

      const walk = (node) => {
        if (node?.name === targetName) out.push(node);
        const kids = node?.children || [];
        for (const k of kids) walk(k);
      };
      walk(root);
      return out;
    }

    function initScene(){
      const scene = mv.model?.sceneGraph;
      if (!scene) return;

      nodeMap.clear();

      for (const p of PARTS){
        const nodes = findNodesByName(scene, p.id);
        nodeMap.set(p.id, nodes);
      }

      // Glas automatisch: falls GLAS vorhanden, Materialpreset anwenden
      applyGlassPresetIfPresent();
      // initiale Toggle anwenden
      applyAllTogglesFromUI();
      // Debug: fehlende Nodes melden (optional)
      logMissingParts();
    }

    function setPartVisible(partId, visible){
      const nodes = nodeMap.get(partId) || [];
      for (const n of nodes){
        n.visible = !!visible;
      }
      mv.requestRender();
    }

    function applyAllTogglesFromUI(){
      document.querySelectorAll('input[data-part]').forEach(cb => {
        setPartVisible(cb.dataset.part, cb.checked);
      });
    }

    togglesEl.addEventListener('change', (e) => {
      const cb = e.target;
      if (!(cb instanceof HTMLInputElement)) return;
      const partId = cb.dataset.part;
      if (!partId) return;
      setPartVisible(partId, cb.checked);
    });

    document.getElementById('allOn').addEventListener('click', () => {
      document.querySelectorAll('input[data-part]').forEach(cb => cb.checked = true);
      applyAllTogglesFromUI();
    });
    document.getElementById('allOff').addEventListener('click', () => {
      document.querySelectorAll('input[data-part]').forEach(cb => cb.checked = false);
      applyAllTogglesFromUI();
    });
    document.getElementById('reset').addEventListener('click', () => {
      mv.cameraOrbit = "45deg 65deg 12m";
      mv.fieldOfView = "30deg";
    });

    function logMissingParts(){
      const missing = [];
      for (const p of PARTS){
        const nodes = nodeMap.get(p.id) || [];
        if (!nodes.length) missing.push(p.id);
      }
      if (missing.length){
        console.warn("Diese Bauteile wurden im GLB nicht gefunden (Name/Case prüfen):", missing);
      }
    }

    // === Glas Preset (robust, ohne harte Shader-Spielereien) ===
    function applyGlassPresetIfPresent(){
      // model-viewer: Zugriff auf Materialien über mv.model.materials
      const model = mv.model;
      if (!model) return;

      const hasGlassNode = (nodeMap.get('GLAS') || []).length > 0;

      // Materialnamen können variieren – wir versuchen "GLAS" zu matchen
      const mats = model.materials || [];
      const glassMats = mats.filter(m => {
        const name = (m.name || "").toLowerCase();
        return name.includes("glas") || name.includes("glass");
      });

      if (!hasGlassNode && glassMats.length === 0) return;

      // Preset: transparente Scheibe, sauber & performant
      for (const m of glassMats){
        try{
          const pbr = m.pbrMetallicRoughness;
          if (pbr){
            pbr.setBaseColorFactor([1,1,1,0.18]); // leicht sichtbar
            pbr.setMetallicFactor(0.0);
            pbr.setRoughnessFactor(0.05);
          }
          // Transmission Extension, falls vorhanden
          if (m.setTransmissionFactor) m.setTransmissionFactor(1.0);
          if (m.setIor) m.setIor(1.45);
          if (m.setThicknessFactor) m.setThicknessFactor(0.01);
        }catch(err){
          // still ok
        }
      }
      mv.requestRender();
    }

    // === AR Status Anzeige ===
    async function updateArStatus(){
      const dot = document.getElementById('arDot');
      const txt = document.getElementById('arTxt');

      try{
        // model-viewer API: canActivateAR
        const can = await mv.canActivateAR;
        if (can){
          dot.className = 'dot ok';
          txt.textContent = 'AR bereit';
        } else {
          dot.className = 'dot bad';
          txt.textContent = 'AR nicht verfügbar';
        }
      }catch{
        dot.className = 'dot bad';
        txt.textContent = 'AR Status unbekannt';
      }
    }
  </script>
</body>
</html>
